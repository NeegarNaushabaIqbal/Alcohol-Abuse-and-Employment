---
title: "R Notebook"
output: html_notebook
---

```{r}
library(readr)
library(ggplot2)
library(ggpubr)
library(zoo)
library(tidyr)
library(purrr)
library(MASS)
library(tidyverse)
library(lubridate)
library(viridis)
library(reshape2)
library(ggdendro)
library(plm)
library(sandwich)
library(lmtest)
library(clubSandwich)
```

```{r}
install.packages("wooldridge")
library(wooldridge)
```

```{r}
data("alcohol")
```

```{r}
alcohol
```

```{r}
num_employed <- nrow(alcohol[alcohol$employ == 1, ])
frac_employed <- num_employed / nrow(alcohol)
num_employed
frac_employed
```

```{r}
num_abuse <- nrow(alcohol[alcohol$abuse == 1, ])
frac_abuse <- num_abuse / nrow(alcohol)
num_abuse 
frac_abuse
```

```{r}
# Fit the simple regression
reg <- lm(employ ~ abuse, data = alcohol)

# Obtain heteroskedasticity-robust standard errors
robust_se <- coeftest(reg, vcov = vcovHC(reg, type = "HC1"))

robust_se
```

```{r}
probit_model <- glm(employ ~ abuse, data = alcohol, family = binomial(link = "probit"))

# Summary
summary(probit_model)
```

```{r}
install.packages("margins")
```

```{r}
library(margins)

ape <- margins(probit_model)
summary(ape)
```

```{r}
logit_model <- glm(employ ~ abuse, data = alcohol, family = binomial(link = "logit"))

# Summary of coefficients
summary(logit_model)
```

```{r}
logit_ame <- margins(logit_model)
summary(logit_ame)
```

```{r}
# Fit probit model
probit_model_robust <- glm(employ ~ abuse, data = alcohol, family = binomial(link = "probit"))

# Robust standard errors (HC1)
probit_robust <- coeftest(probit_model_robust, vcov = vcovHC(probit_model_robust, type = "HC1"))

probit_robust
```

```{r}
probit_ame_robust <- margins(probit_model_robust, vcov = vcovHC(probit_model_robust, type = "HC1"))
summary(probit_ame_robust)
```

```{r}
logit_model_robust <- glm(employ ~ abuse, data = alcohol, family = binomial(link = "logit"))

# Robust standard errors
logit_robust <- coeftest(logit_model_robust, vcov = vcovHC(logit_model_robust, type = "HC1"))

logit_robust
```

```{r}
logit_ame_robust <- margins(logit_model_robust, vcov = vcovHC(logit_model_robust, type = "HC1"))
summary(logit_ame_robust)
```

```{r}
b0 <- 1.2872   # intercept
b1 <- -0.1480  # slope for abuse

# Compute fitted probabilities using the normal CDF
p_abuse0 <- pnorm(b0 + b1 * 0)   # when abuse = 0
p_abuse1 <- pnorm(b0 + b1 * 1)   # when abuse = 1

p_abuse0
p_abuse1
```

```{r}
lpm_extended <- lm(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                     white + northeast + midwest + south + centcity + outercity +
                     qrt1 + qrt2 + qrt3, 
                   data = alcohol)

coeftest(lpm_extended, vcov = vcovHC(lpm_extended, type = "HC1"))
```

```{r}
probit_extended <- glm(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                         white + northeast + midwest + south + centcity + outercity +
                         qrt1 + qrt2 + qrt3,
                       family = binomial(link = "probit"),
                       data = alcohol)
```

```{r}
summary(probit_extended)
```

```{r}
# Compute heteroskedasticity-robust standard errors
vcov_robust <- vcovHC(probit_extended, type = "HC1")

# Compute Average Marginal Effects (AMEs) with robust SEs
margins_probit <- margins(probit_extended, vcov = vcov_robust)
summary(margins_probit)
```

```{r}
install.packages("AER")
```

```{r}
library(AER)
```

```{r}
# 2SLS / IV regression: LPM
iv_lpm <- ivreg(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3
                | mothalc + fathalc + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3, 
                data = alcohol)

coeftest(iv_lpm, vcov = vcovHC(iv_lpm, type = "HC1"))
```

```{r}
summary(iv_lpm, diagnostics = TRUE)
```

```{r}
install.packages("GJRM")  # or use "sampleSelection" or "mvProbit"
library(GJRM)
```

```{r}
f1 <- employ ~ abuse + age + agesq + educ + educsq + married + famsize +
  white + northeast + midwest + south + centcity + outercity +
  qrt1 + qrt2 + qrt3

f2 <- abuse ~ mothalc + fathalc + age + agesq + educ + educsq + married +
  famsize + white + northeast + midwest + south + centcity + outercity +
  qrt1 + qrt2 + qrt3

biv_probit <- gjrm(list(f1, f2), data = alcohol, margins = c("probit", "probit"), model = "B")
summary(biv_probit)
```

```{r}
set.seed(123)
ape_boot <- ATE(x = biv_probit, trt = "abuse", eq = 1, n.sim = 1000)
ape_boot
```

```{r}
??GJRM::ME
```

```{r}
packageVersion("GJRM")
```

```{r}
first_stage <- lm(abuse ~ mothalc + fathalc + age + agesq + educ + educsq + married +
                    famsize + white + northeast + midwest + south + centcity + outercity +
                    qrt1 + qrt2 + qrt3, data = alcohol)
alcohol$residuals_abuse <- resid(first_stage)
```

```{r}
second_stage <- glm(employ ~ abuse + residuals_abuse + age + agesq + educ + educsq +
                      married + famsize + white + northeast + midwest + south +
                      centcity + outercity + qrt1 + qrt2 + qrt3,
                    family = binomial(link = "probit"),
                    data = alcohol)
summary(second_stage)
```

```{r}
ape_2sri <- margins(second_stage, variables = "abuse")
summary(ape_2sri)
```

```{r}
set.seed(123)
n_boot <- 1000
boot_coefs <- replicate(n_boot, {
  # sample indices with replacement
  ids <- sample(1:nrow(alcohol), replace = TRUE)
  dat_boot <- alcohol[ids, ]
  
  # first stage
  fs <- lm(abuse ~ mothalc + fathalc + age + agesq + educ + educsq + married +
             famsize + white + northeast + midwest + south + centcity + outercity +
             qrt1 + qrt2 + qrt3, data = dat_boot)
  dat_boot$residuals_abuse <- resid(fs)
  
  # second stage
  ss <- glm(employ ~ abuse + residuals_abuse + age + agesq + educ + educsq +
              married + famsize + white + northeast + midwest + south +
              centcity + outercity + qrt1 + qrt2 + qrt3,
            family = binomial(link = "probit"),
            data = dat_boot)
  
  coef(ss)["abuse"]
})

# bootstrap standard error
sd(boot_coefs)
# bootstrap 95% CI
quantile(boot_coefs, c(0.025, 0.975))
```

```{r}
install.packages("parallel")
library(parallel)
```

```{r}

set.seed(123)
n_boot <- 1000
n_cores <- detectCores() - 1

cl <- makeCluster(n_cores)
clusterExport(cl, c("alcohol"))

boot_fun <- function(i) {
  ids <- sample(1:nrow(alcohol), replace = TRUE)
  dat_boot <- alcohol[ids, ]
  
  fs <- lm(abuse ~ mothalc + fathalc + age + agesq + educ + educsq + married +
           famsize + white + northeast + midwest + south + centcity + outercity +
           qrt1 + qrt2 + qrt3, data = dat_boot)
  dat_boot$residuals_abuse <- resid(fs)
  
  ss <- glm(employ ~ abuse + residuals_abuse + age + agesq + educ + educsq +
            married + famsize + white + northeast + midwest + south +
            centcity + outercity + qrt1 + qrt2 + qrt3,
            family = binomial(link = "probit"),
            data = dat_boot)
  
  # Manual marginal effect
  beta_abuse <- coef(ss)["abuse"]
  linear_pred <- predict(ss, type = "link")
  avg_density <- mean(dnorm(linear_pred))
  
  return(beta_abuse * avg_density)
}

boot_ape <- parSapply(cl, 1:n_boot, boot_fun)
stopCluster(cl)

# Results
cat("Bootstrap Mean APE:", mean(boot_ape), "\n")
cat("Bootstrap SE:", sd(boot_ape), "\n")
cat("Bootstrap 95% CI:", quantile(boot_ape, c(0.025, 0.975)), "\n")
```

```{r}
first_stage_full <- lm(abuse ~ mothalc + fathalc + age + agesq + 
                       educ + educsq + married + famsize + white + 
                       northeast + midwest + south + centcity + 
                       outercity + qrt1 + qrt2 + qrt3, 
                       data = alcohol)

first_stage_restricted <- lm(abuse ~ age + agesq + educ + educsq + 
                             married + famsize + white + northeast + 
                             midwest + south + centcity + outercity + 
                             qrt1 + qrt2 + qrt3, 
                             data = alcohol)

# Partial R² of instruments
r2_full <- summary(first_stage_full)$r.squared
r2_restricted <- summary(first_stage_restricted)$r.squared
partial_r2 <- r2_full - r2_restricted

cat("Partial R² of instruments:", partial_r2, "\n")

```

```{r}
ape_margins <- summary(margins(second_stage, variables = "abuse"))$AME

# Method 2: Manual calculation - FAST
beta_abuse <- coef(second_stage)["abuse"]
linear_pred <- predict(second_stage, type = "link")
avg_density <- mean(dnorm(linear_pred))
ape_manual <- beta_abuse * avg_density

# Compare
cat("APE from margins():", ape_margins, "\n")
cat("APE manual:", ape_manual, "\n")
cat("Difference:", abs(ape_margins - ape_manual), "\n")
```

```{r}
# Create a combined factor for plotting
alcohol$parent_status <- paste0(
  "Mother: ", ifelse(alcohol$mothalc == 1, "Alcoholic", "Non-Alcoholic"), ", ",
  "Father: ", ifelse(alcohol$fathalc == 1, "Alcoholic", "Non-Alcoholic")
)

ggplot(alcohol, aes(x = parent_status)) +
  geom_bar(fill = "steelblue") +
  theme_pubr() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) +
  labs(title = "Number of Individuals by Parental Alcoholism",
       x = "Parental Status",
       y = "Count")
```

```{r}
# Proxy for "complier-like" based on instrument strength
alcohol$instrument_strength <- with(alcohol, mothalc + fathalc) 

alcohol_1  <- alcohol %>% group_by(instrument_strength, abuse) %>% summarise( n = n(), mean_employ = mean(employ) ) %>% tidyr::pivot_wider(names_from = abuse, values_from = c(n, mean_employ), names_sep = "_")
```

```{r}
p_compliers <- 0.005
late <- -0.32
ate <- -0.19

# ATE = p_compliers × LATE + (1 - p_compliers) × Effect_others
# -0.19 = 0.005 × (-0.32) + 0.995 × Effect_others
effect_others <- (-0.19 - 0.005 * (-0.32)) / 0.995
cat("Implied effect for non-compliers:", effect_others, "\n")
```
