---
title: "R Notebook"
output: html_notebook
---

```{r}
library(readr)
library(ggplot2)
library(ggpubr)
library(zoo)
library(tidyr)
library(purrr)
library(MASS)
library(tidyverse)
library(lubridate)
library(viridis)
library(reshape2)
library(ggdendro)
library(plm)
library(sandwich)
library(lmtest)
library(clubSandwich)
```

```{r}
install.packages("wooldridge")
library(wooldridge)
```

```{r}
data("alcohol")
```

```{r}
alcohol
```

```{r}
lpm_extended_1 <- lm(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                     white + northeast + midwest + south + centcity + outercity +
                     qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth, 
                   data = alcohol)

coeftest(lpm_extended_1, vcov = vcovHC(lpm_extended_1, type = "HC1"))
```

```{r}
probit_extended_1 <- glm(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                         white + northeast + midwest + south + centcity + outercity +
                         qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth,
                       family = binomial(link = "probit"),
                       data = alcohol)

summary(probit_extended_1)
```

```{r}
library(margins)
```

```{r}
# Compute heteroskedasticity-robust standard errors
vcov_robust_1 <- vcovHC(probit_extended_1, type = "HC1")

# Compute Average Marginal Effects (AMEs) with robust SEs
margins_probit_1 <- margins(probit_extended_1, vcov = vcov_robust_1)
summary(margins_probit_1)
```

```{r}
library(AER)
```

```{r}
# 2SLS / IV regression: LPM
iv_lpm_1 <- ivreg(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth
                | mothalc + fathalc + livealc + beertax + cigtax + ethanol + beertaxsq + cigtaxsq + ethanolsq + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth, 
                data = alcohol)

coeftest(iv_lpm_1, vcov = vcovHC(iv_lpm_1, type = "HC1"))
```

```{r}
summary(iv_lpm_1, diagnostics = TRUE)
```

```{r}
iv_lpm_2 <- ivreg(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth
                | mothalc + fathalc + livealc + beertax + ethanol + beertaxsq + ethanolsq + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth, 
                data = alcohol)

coeftest(iv_lpm_2, vcov = vcovHC(iv_lpm_2, type = "HC1"))
```

```{r}
summary(iv_lpm_2, diagnostics = TRUE)
```

```{r}
iv_lpm_3 <- ivreg(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth
                | mothalc + fathalc + livealc + beertax + beertaxsq + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth, 
                data = alcohol)

coeftest(iv_lpm_3, vcov = vcovHC(iv_lpm_3, type = "HC1"))
```

```{r}
summary(iv_lpm_3, diagnostics = TRUE)
```

```{r}
iv_lpm_4 <- ivreg(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth
                | mothalc + fathalc + livealc + beertax + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth, 
                data = alcohol)

coeftest(iv_lpm_4, vcov = vcovHC(iv_lpm_4, type = "HC1"))
```

```{r}
summary(iv_lpm_4, diagnostics = TRUE)
```

```{r}
iv_lpm_5 <- ivreg(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth
                | mothalc + fathalc + livealc + beertax + ethanol + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth, 
                data = alcohol)

coeftest(iv_lpm_5, vcov = vcovHC(iv_lpm_5, type = "HC1"))
```

```{r}
summary(iv_lpm_5, diagnostics = TRUE)
```

```{r}
iv_lpm_6 <- ivreg(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth
                | mothalc + fathalc + livealc + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth, 
                data = alcohol)

coeftest(iv_lpm_6, vcov = vcovHC(iv_lpm_6, type = "HC1"))
```

```{r}
summary(iv_lpm_6, diagnostics = TRUE)
```

```{r}
iv_lpm_7 <- ivreg(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth
                | mothalc + fathalc + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth, 
                data = alcohol)

coeftest(iv_lpm_7, vcov = vcovHC(iv_lpm_7, type = "HC1"))
```

```{r}
summary(iv_lpm_7, diagnostics = TRUE)
```

```{r}
iv_lpm_8 <- ivreg(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth
                | livealc + beertax + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth, 
                data = alcohol)

coeftest(iv_lpm_8, vcov = vcovHC(iv_lpm_8, type = "HC1"))
```

```{r}
summary(iv_lpm_8, diagnostics = TRUE)
```

```{r}
iv_lpm_9 <- ivreg(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth
                | livealc + beertax + ethanol + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth, 
                data = alcohol)

coeftest(iv_lpm_9, vcov = vcovHC(iv_lpm_9, type = "HC1"))
```

```{r}
summary(iv_lpm_9, diagnostics = TRUE)
```

```{r}
iv_lpm_10 <- ivreg(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth
                | beertax + ethanol + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth, 
                data = alcohol)

coeftest(iv_lpm_10, vcov = vcovHC(iv_lpm_10, type = "HC1"))
```

```{r}
summary(iv_lpm_10, diagnostics = TRUE)
```

```{r}
iv_lpm_11 <- ivreg(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth
                | livealc + ethanol + age + agesq + educ + educsq + married + famsize +
                  white + northeast + midwest + south + centcity + outercity +
                  qrt1 + qrt2 + qrt3 + unemrate + exhealth + vghealth + goodhealth + fairhealth, 
                data = alcohol)

coeftest(iv_lpm_11, vcov = vcovHC(iv_lpm_11, type = "HC1"))
```

```{r}
summary(iv_lpm_11, diagnostics = TRUE)
```

```{r}
# iv_lpm_7 is final. mothalc and fathalc main instruments
# Need to discuss iv_lpm_11, iv_lpm_9, and iv_lpm_8
```

```{r}
library(GJRM)
```

```{r}
f1_1 <- employ ~ abuse + age + agesq + educ + educsq + married + famsize +
  white + northeast + midwest + south + centcity + outercity +
  qrt1 + qrt2 + qrt3 + unemrate + exhealth + 
    vghealth + goodhealth + fairhealth

f2_1 <- abuse ~ mothalc + fathalc + age + agesq + educ + educsq + married +
  famsize + white + northeast + midwest + south + centcity + outercity +
  qrt1 + qrt2 + qrt3 + unemrate + exhealth + 
    vghealth + goodhealth + fairhealth

biv_probit_1 <- gjrm(list(f1_1, f2_1), data = alcohol, margins = c("probit", "probit"), model = "B")
summary(biv_probit_1)
```

```{r}
set.seed(123)
ape_boot_1 <- ATE(x = biv_probit_1, trt = "abuse", eq = 1, n.sim = 10000)
ape_boot_1
```

```{r}
lpm_extended_2 <- lm(employ ~ abuse + age + agesq + educ + educsq + married + famsize + white + unemrate + exhealth + vghealth + goodhealth + fairhealth, 
                   data = alcohol)

coeftest(lpm_extended_2, vcov = vcovHC(lpm_extended_2, type = "HC1"))
```

```{r}
probit_extended_2 <- glm(employ ~ abuse + age + agesq + educ + educsq + married + famsize + white + unemrate + exhealth + vghealth + goodhealth + fairhealth,
                       family = binomial(link = "probit"),
                       data = alcohol)

summary(probit_extended_2)
```

```{r}
# Compute heteroskedasticity-robust standard errors
vcov_robust_2 <- vcovHC(probit_extended_2, type = "HC1")

# Compute Average Marginal Effects (AMEs) with robust SEs
margins_probit_2 <- margins(probit_extended_2, vcov = vcov_robust_2)
summary(margins_probit_2)
```

```{r}
iv_lpm_compressed <- ivreg(employ ~ abuse + age + agesq + educ + educsq + married + famsize + white + unemrate + exhealth + vghealth + goodhealth + fairhealth
                | mothalc + fathalc + age + agesq + educ + educsq + married + famsize + white + unemrate + exhealth + vghealth + goodhealth + fairhealth, 
                data = alcohol)

coeftest(iv_lpm_compressed, vcov = vcovHC(iv_lpm_compressed, type = "HC1"))
```

```{r}
summary(iv_lpm_compressed, diagnostics = TRUE)
```

```{r}
install.packages("robomit")
```

```{r}
library(robomit)
```

```{r}
f1_2 <- employ ~ abuse + age + agesq + educ + educsq + married + famsize + 
  white + unemrate + exhealth + 
    vghealth + goodhealth + fairhealth

f2_2 <- abuse ~ mothalc + fathalc + age + agesq + educ + educsq + married +
  famsize + white + unemrate + exhealth + 
    vghealth + goodhealth + fairhealth

biv_probit_2 <- gjrm(list(f1_2, f2_2), data = alcohol, margins = c("probit", "probit"), model = "B")
summary(biv_probit_2)
```

```{r}
set.seed(123)
ape_boot_2 <- ATE(x = biv_probit_2, trt = "abuse", eq = 1, n.sim = 10000)
ape_boot_2
```

```{r}
first_stage_2 <- glm(abuse ~ mothalc + fathalc + age + agesq + educ + educsq + married +
                    famsize + white + unemrate + exhealth + 
    vghealth + goodhealth + fairhealth, family = binomial(link = "probit"),
    data = alcohol)

alcohol$residuals_abuse <- resid(first_stage_2)
```

```{r}
second_stage_2 <- glm(employ ~ abuse + residuals_abuse + age + agesq + educ + educsq +
                      married + famsize + white + unemrate + exhealth + 
    vghealth + goodhealth + fairhealth,
                    family = binomial(link = "probit"),
                    data = alcohol)
summary(second_stage_2)
```

```{r}
ape_2sri_2 <- margins(second_stage_2, variables = "abuse")
summary(ape_2sri_2)
```

```{r}
library(parallel)
```

```{r}
set.seed(123)
n_boot <- 10000
n_cores <- detectCores() - 1

cl <- makeCluster(n_cores)
clusterExport(cl, c("alcohol"))

boot_fun <- function(i) {
  ids <- sample(1:nrow(alcohol), replace = TRUE)
  dat_boot <- alcohol[ids, ]
  
  fs <- glm(abuse ~ mothalc + fathalc + age + agesq + educ + educsq + married +
           famsize + white + unemrate + exhealth + 
    vghealth + goodhealth + fairhealth, family = binomial(link = "probit"), data = dat_boot)
  dat_boot$residuals_abuse <- resid(fs)
  
  ss <- glm(employ ~ abuse + residuals_abuse + age + agesq + educ + educsq +
            married + famsize + white + unemrate + exhealth + 
    vghealth + goodhealth + fairhealth,
            family = binomial(link = "probit"),
            data = dat_boot)
  
  # Manual marginal effect
  beta_abuse <- coef(ss)["abuse"]
  linear_pred <- predict(ss, type = "link")
  avg_density <- mean(dnorm(linear_pred))
  
  return(beta_abuse * avg_density)
}

boot_ape <- parSapply(cl, 1:n_boot, boot_fun)
stopCluster(cl)

# Results
cat("Bootstrap Mean APE:", mean(boot_ape), "\n")
```

```{r}
cat("Bootstrap SE:", sd(boot_ape), "\n")
```

```{r}
cat("Bootstrap 95% CI:", quantile(boot_ape, c(0.025, 0.975)), "\n")
```

```{r}
# # Few people are affected by instruments
# first_stage_full_2 <- lm(abuse ~ mothalc + fathalc + age + agesq + 
#                        educ + educsq + married + famsize + white + unemrate + exhealth + 
#     vghealth + goodhealth + fairhealth, 
#                        data = alcohol)
# 
# first_stage_restricted_2 <- lm(abuse ~ age + agesq + educ + educsq + 
#                              married + famsize + white + unemrate + exhealth + 
#     vghealth + goodhealth + fairhealth, 
#                              data = alcohol)
# 
# # Partial R² of instruments
# r2_full_2 <- summary(first_stage_full_2)$r.squared
# r2_restricted_2 <- summary(first_stage_restricted_2)$r.squared
# partial_r2_2 <- r2_full_2 - r2_restricted_2
# 
# cat("Partial R² of instruments:", partial_r2_2, "\n")
```

```{r}
# ape_margins_2 <- summary(margins(second_stage_2, variables = "abuse"))$AME
# 
# # Method 2: Manual calculation - FAST
# beta_abuse_2 <- coef(second_stage_2)["abuse"]
# linear_pred_2 <- predict(second_stage_2, type = "link")
# avg_density_2 <- mean(dnorm(linear_pred_2))
# ape_manual_2 <- beta_abuse_2 * avg_density_2
# 
# # Compare
# cat("APE from margins():", ape_margins_2, "\n")
# cat("APE manual:", ape_manual_2, "\n")
# cat("Difference:", abs(ape_margins_2 - ape_manual_2), "\n")
```

```{r}
# Check monotonicity
alcohol$instrument_strength <- with(alcohol, mothalc + fathalc) 

alcohol_2  <- alcohol %>% group_by(instrument_strength, abuse) %>% summarise( n = n(), mean_employ = mean(employ) ) %>% tidyr::pivot_wider(names_from = abuse, values_from = c(n, mean_employ), names_sep = "_")
```

```{r}
parent_alc_lpm <- lm(abuse ~ mothalc + fathalc + age + agesq + educ + educsq +
                    married + famsize + white + unemrate + exhealth + vghealth +
                    goodhealth + fairhealth, data = alcohol)
```

```{r}
coeftest(parent_alc_lpm, vcov = vcovHC(parent_alc_lpm, type = "HC1"))
```

```{r}
probit_extended <- glm(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                         white + northeast + midwest + south + centcity + outercity +
                         qrt1 + qrt2 + qrt3,
                       family = binomial(link = "probit"),
                       data = alcohol)
```

```{r}
summary(probit_extended)
```

```{r}
# Compute heteroskedasticity-robust standard errors
vcov_robust <- vcovHC(probit_extended, type = "HC1")

# Compute Average Marginal Effects (AMEs) with robust SEs
margins_probit <- margins(probit_extended, vcov = vcov_robust)
summary(margins_probit)
```

```{r}
AIC(probit_extended, probit_extended_1, probit_extended_2)
BIC(probit_extended, probit_extended_1, probit_extended_2)
```

```{r}
lpm_extended <- lm(employ ~ abuse + age + agesq + educ + educsq + married + famsize +
                     white + northeast + midwest + south + centcity + outercity +
                     qrt1 + qrt2 + qrt3, 
                   data = alcohol)

coeftest(lpm_extended, vcov = vcovHC(lpm_extended, type = "HC1"))
```

```{r}
AIC(lpm_extended, lpm_extended_1, lpm_extended_2)
BIC(lpm_extended, lpm_extended_1, lpm_extended_2)
```
